#!/bin/bash
set -e

exit_handler() {
    [[ ! $? = 0 ]] && echo "What did you do to Mr. Crochet :("
    rm -rf $TMPDIR &>/dev/null
    exit 0
}

trap exit_handler EXIT

TMPDIR=$(mktemp -d)
ARCHIVE=$(basename $(mktemp -t XXXXXXXXXXX -u)).zip

echo __________________________░░________░░__________________________░░__░░______░░__________
echo ░░__________________________________________________________________________░░__________
echo ░░░░__░░░░░░__░░░░░░░░░░____________________░░________░░░░░░__░░__░░░░░░░░__░░░░░░░░░░__
echo ____░░______░░__________________▓▓▓▓▓▓________░░▓▓▓▓▓▓░░__░░░░______░░░░________░░____░░
echo ░░____________________________▓▓▓▓▓▓▓▓▓▓______▓▓▓▓▓▓▓▓▓▓________________________________
echo ________________░░░░░░______▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓░░________________░░__░░░░____
echo ░░____░░__░░____░░░░░░░░__▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓▓________░░░░░░░░░░__________
echo ░░__░░____░░______________▓▓▓▓▓▓▓▓▓▓░░░░░░░░░░░░░░▓▓▓▓▓▓▓▓▓▓________░░__________░░__░░__
echo ░░____________________░░__▓▓▓▓▓▓▓▓░░░░░░░░░░░░░░░░░░▓▓▓▓▓▓▓▓________░░__________░░______
echo __textart.sh/topic/hook_____▓▓▓▓▓▓██░░▓▓░░░░░░▓▓░░██▓▓▓▓▓▓____▒▒___________Mr. Crochet__
echo ____________░░________________▓▓████░░░░░░░░░░░░░░████▓▓__░░▒▒__▒▒__░░__________________
echo ____░░____░░░░____░░______░░____██░░░░████░░████░░░░██____░░__░░▒▒__░░░░__░░░░______░░__
echo ____________________________░░██████░░░░______░░░░████______▒▒▒▒▒▒____________░░________
echo ░░░░__░░________░░░░____░░░░__████████░░░░░░░░░░████████____▒▒__________░░______________
echo ░░__░░______________________████████████░░░░░░██████████▒▒____░░░░__░░________░░__░░____
echo ░░________________________░░░░██████▒▒▒▒______▒▒▒▒██████▒▒▒▒▒▒______░░__░░__░░__________
echo ____░░______░░______________░░__▒▒▒▒▒▒▒▒▒▒__▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒▒░░______░░░░__░░░░__________
echo ░░______░░░░░░__░░░░░░____░░__▒▒▒▒▒▒▒▒▒▒▒▒__▒▒▒▒▒▒▒▒▒▒▒▒▒▒░░____░░░░░░░░__░░░░____░░░░__
echo ░░______░░________░░______░░▒▒▒▒░░▒▒▒▒▒▒▒▒__▒▒▒▒▒▒▒▒░░__░░░░__░░________________________
echo ░░__░░____________________▒▒▒▒▒▒____▒▒▒▒▒▒__▒▒▒▒▒▒____________________________░░░░░░____
echo ░░________░░░░__________▒▒▒▒▒▒__░░__▒▒▒▒__▓▓__▒▒▒▒____░░░░__░░__________________░░__░░__
echo ____________░░____________________▒▒▒▒__▓▓▓▓▓▓__▒▒▒▒░░__________░░__░░________░░________
echo ░░________________________░░░░__▒▒▒▒__▓▓▓▓▒▒▓▓▓▓__▒▒▒▒__________░░__░░░░____░░__░░______
echo ░░____░░________________░░░░__▒▒▒▒________▒▒________▒▒▒▒░░____░░____░░__________________
echo ________________░░░░__________▒▒__██______________██__▒▒░░░░________________░░░░________
echo ________________________________░░__██__██__██__██________░░____________________________
echo ____________░░____________░░______████████__████████░░__________________░░____░░________
echo __░░__░░__░░__░░░░______░░░░____██████████__██████████__░░____░░____░░______________░░__
echo __░░░░░░░░░░__░░░░__░░__░░░░░░______░░__░░__░░░░____░░__░░____░░░░____░░░░__░░░░____░░__
echo
echo "Meet Mr. Crochet, he is so kind that he's willing to sign your Git repo by making his own commit!"
echo "Send him your Git repo as a Base64 encoded ZIP archive (in multiple lines, not as a single long line), and he'll do the rest."
echo "Once you send your Base64 lines, send a final line containing the string: EOF"

{
    cd $TMPDIR
    while read line; do [[ "$line" = "EOF" ]] && break; echo -n $line >> zip.b64; done
    base64 -d zip.b64 > $ARCHIVE && rm zip.b64
    unzip $ARCHIVE && rm $ARCHIVE
    folder=$(find -type d -name .git)
    folder=${folder%/*}
    cd $folder
    git commit --allow-empty -m "Signed by Mr. Crochet... Love <3"
    cd -
    zip -ro $ARCHIVE $folder
} &>/dev/null

base64 $ARCHIVE